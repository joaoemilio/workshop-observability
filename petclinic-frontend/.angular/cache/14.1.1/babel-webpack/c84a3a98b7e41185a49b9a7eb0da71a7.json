{"ast":null,"code":"var _excluded = [\"tags\"];\n\nfunction _objectWithoutPropertiesLoose(source, excluded) {\n  if (source == null) return {};\n  var target = {};\n  var sourceKeys = Object.keys(source);\n  var key, i;\n\n  for (i = 0; i < sourceKeys.length; i++) {\n    key = sourceKeys[i];\n    if (excluded.indexOf(key) >= 0) continue;\n    target[key] = source[key];\n  }\n\n  return target;\n}\n\nimport { createStackTraces, filterInvalidFrames } from './stack-trace';\nimport { generateRandomId, merge, extend } from '../common/utils';\nimport { getPageContext } from '../common/context';\nimport { truncateModel, ERROR_MODEL } from '../common/truncate';\nimport stackParser from 'error-stack-parser';\nvar IGNORE_KEYS = ['stack', 'message'];\n\nfunction getErrorProperties(error) {\n  var propertyFound = false;\n  var properties = {};\n  Object.keys(error).forEach(function (key) {\n    if (IGNORE_KEYS.indexOf(key) >= 0) {\n      return;\n    }\n\n    var val = error[key];\n\n    if (val == null || typeof val === 'function') {\n      return;\n    }\n\n    if (typeof val === 'object') {\n      if (typeof val.toISOString !== 'function') return;\n      val = val.toISOString();\n    }\n\n    properties[key] = val;\n    propertyFound = true;\n  });\n\n  if (propertyFound) {\n    return properties;\n  }\n}\n\nvar ErrorLogging = function () {\n  function ErrorLogging(apmServer, configService, transactionService) {\n    this._apmServer = apmServer;\n    this._configService = configService;\n    this._transactionService = transactionService;\n  }\n\n  var _proto = ErrorLogging.prototype;\n\n  _proto.createErrorDataModel = function createErrorDataModel(errorEvent) {\n    var frames = createStackTraces(stackParser, errorEvent);\n    var filteredFrames = filterInvalidFrames(frames);\n    var culprit = '(inline script)';\n    var lastFrame = filteredFrames[filteredFrames.length - 1];\n\n    if (lastFrame && lastFrame.filename) {\n      culprit = lastFrame.filename;\n    }\n\n    var message = errorEvent.message,\n        error = errorEvent.error;\n    var errorMessage = message;\n    var errorType = '';\n    var errorContext = {};\n\n    if (error && typeof error === 'object') {\n      errorMessage = errorMessage || error.message;\n      errorType = error.name;\n      var customProperties = getErrorProperties(error);\n\n      if (customProperties) {\n        errorContext.custom = customProperties;\n      }\n    }\n\n    if (!errorType) {\n      if (errorMessage && errorMessage.indexOf(':') > -1) {\n        errorType = errorMessage.split(':')[0];\n      }\n    }\n\n    var currentTransaction = this._transactionService.getCurrentTransaction();\n\n    var transactionContext = currentTransaction ? currentTransaction.context : {};\n\n    var _this$_configService$ = this._configService.get('context'),\n        tags = _this$_configService$.tags,\n        configContext = _objectWithoutPropertiesLoose(_this$_configService$, _excluded);\n\n    var pageContext = getPageContext();\n    var context = merge({}, pageContext, transactionContext, configContext, errorContext);\n    var errorObject = {\n      id: generateRandomId(),\n      culprit: culprit,\n      exception: {\n        message: errorMessage,\n        stacktrace: filteredFrames,\n        type: errorType\n      },\n      context: context\n    };\n\n    if (currentTransaction) {\n      errorObject = extend(errorObject, {\n        trace_id: currentTransaction.traceId,\n        parent_id: currentTransaction.id,\n        transaction_id: currentTransaction.id,\n        transaction: {\n          type: currentTransaction.type,\n          sampled: currentTransaction.sampled\n        }\n      });\n    }\n\n    return truncateModel(ERROR_MODEL, errorObject);\n  };\n\n  _proto.logErrorEvent = function logErrorEvent(errorEvent) {\n    if (typeof errorEvent === 'undefined') {\n      return;\n    }\n\n    var errorObject = this.createErrorDataModel(errorEvent);\n\n    if (typeof errorObject.exception.message === 'undefined') {\n      return;\n    }\n\n    this._apmServer.addError(errorObject);\n  };\n\n  _proto.registerListeners = function registerListeners() {\n    var _this = this;\n\n    window.addEventListener('error', function (errorEvent) {\n      return _this.logErrorEvent(errorEvent);\n    });\n    window.addEventListener('unhandledrejection', function (promiseRejectionEvent) {\n      return _this.logPromiseEvent(promiseRejectionEvent);\n    });\n  };\n\n  _proto.logPromiseEvent = function logPromiseEvent(promiseRejectionEvent) {\n    var prefix = 'Unhandled promise rejection: ';\n    var reason = promiseRejectionEvent.reason;\n\n    if (reason == null) {\n      reason = '<no reason specified>';\n    }\n\n    var errorEvent;\n\n    if (typeof reason.message === 'string') {\n      var name = reason.name ? reason.name + ': ' : '';\n      errorEvent = {\n        error: reason,\n        message: prefix + name + reason.message\n      };\n    } else {\n      reason = typeof reason === 'object' ? '<object>' : typeof reason === 'function' ? '<function>' : reason;\n      errorEvent = {\n        message: prefix + reason\n      };\n    }\n\n    this.logErrorEvent(errorEvent);\n  };\n\n  _proto.logError = function logError(messageOrError) {\n    var errorEvent = {};\n\n    if (typeof messageOrError === 'string') {\n      errorEvent.message = messageOrError;\n    } else {\n      errorEvent.error = messageOrError;\n    }\n\n    return this.logErrorEvent(errorEvent);\n  };\n\n  return ErrorLogging;\n}();\n\nexport default ErrorLogging;","map":null,"metadata":{},"sourceType":"module"}